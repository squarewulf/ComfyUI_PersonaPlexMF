(function(){"use strict";class f extends AudioWorkletProcessor{constructor(){super(),this.targetMs=150,this.maxMs=500,this.targetSamples=Math.round(this.targetMs*sampleRate/1e3),this.maxSamples=Math.round(this.maxMs*sampleRate/1e3),this.frames=[],this.offset=0,this.playing=!1,this.pktCount=0,this.totalPlayed=0,this.actualPlayed=0,this.timeInStream=0,this.minDelay=9999,this.maxDelay=0,this.port.onmessage=s=>{if(s.data.type==="reset"){this.frames=[],this.offset=0,this.playing=!1,this.pktCount=0,this.totalPlayed=0,this.actualPlayed=0,this.timeInStream=0,this.minDelay=9999,this.maxDelay=0,console.log("[AUDIO] Reset");return}if(s.data.type==="flush"){let t=this.bufMs();this.frames=[],this.offset=0,this.playing=!1,t>0&&console.log("[AUDIO] FLUSH: dropped",t,"ms");return}if(s.data.type==="config"){const t=s.data;t.maxLatencyMs!==void 0&&(this.maxMs=t.maxLatencyMs,this.maxSamples=Math.round(this.maxMs*sampleRate/1e3)),t.initBufferMs!==void 0&&(this.targetMs=t.initBufferMs,this.targetSamples=Math.round(this.targetMs*sampleRate/1e3)),console.log("[AUDIO] Config: target="+this.targetMs+"ms, max="+this.maxMs+"ms");return}const i=s.data.frame,h=s.data.micDuration||0;if(this.frames.push(i),this.pktCount<5&&console.log("[AUDIO] PKT",this.pktCount++,"buf:",this.bufMs()+"ms"),!this.playing&&this.bufSize()>=this.targetSamples/2&&(this.playing=!0,console.log("[AUDIO] PLAY started, buf:",this.bufMs()+"ms")),this.bufSize()>this.maxSamples){const t=this.bufSize()-this.targetSamples,a=this.drop(t);console.log("[AUDIO] DROP",Math.round(a*1e3/sampleRate)+"ms, buf:",this.bufMs()+"ms")}const e=h-this.timeInStream;e>0&&e<100&&(this.minDelay=Math.min(this.minDelay,e),this.maxDelay=Math.max(this.maxDelay,e)),this.port.postMessage({totalAudioPlayed:this.totalPlayed,actualAudioPlayed:this.actualPlayed,delay:e,minDelay:this.minDelay===9999?0:this.minDelay,maxDelay:this.maxDelay})}}bufSize(){let s=0;for(const i of this.frames)s+=i.length;return s-this.offset}bufMs(){return Math.round(this.bufSize()*1e3/sampleRate)}drop(s){let i=0;for(;i<s&&this.frames.length>0;){const h=this.frames[0],e=h.length-this.offset,t=Math.min(e,s-i);this.offset+=t,this.timeInStream+=t/sampleRate,i+=t,this.offset>=h.length&&(this.frames.shift(),this.offset=0)}return i}process(s,i,h){const e=i[0][0],t=e.length;if(this.bufSize()>this.maxSamples){const l=this.bufSize()-this.targetSamples;this.drop(l)}if(!this.playing||this.frames.length===0)return e.fill(0),this.actualPlayed>0&&(this.totalPlayed+=t/sampleRate),!0;let a=0;for(;a<t&&this.frames.length>0;){const l=this.frames[0],r=l.length-this.offset,o=Math.min(r,t-a);e.set(l.subarray(this.offset,this.offset+o),a),this.offset+=o,a+=o,this.offset>=l.length&&(this.frames.shift(),this.offset=0)}return a<t&&(e.fill(0,a),this.playing=!1,console.log("[AUDIO] UNDERRUN, waiting for buffer")),this.totalPlayed+=t/sampleRate,this.actualPlayed+=a/sampleRate,this.timeInStream+=a/sampleRate,!0}}registerProcessor("moshi-processor",f)})();
